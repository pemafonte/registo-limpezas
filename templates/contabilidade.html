{% extends "base.html" %}
{% block content %}
  <h2>Contabilidade de Limpezas</h2>
  <form method="get" style="margin-bottom:1rem;display:flex;gap:1rem;align-items:end;">
    <label>Mês:
      <input type="month" name="mes" value="{{ mes or '' }}">
    </label>
    <label>Protocolo:
      <select name="protocolo_id">
        <option value="">Todos</option>
        {% for p in protocolos %}
          <option value="{{ p.id }}" {% if protocolo_id and protocolo_id|int == p.id %}selected{% endif %}>{{ p.nome }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Região:
      {% if session['role'] == 'gestor' %}
        <input type="text" name="regiao" value="{{ regiao or '' }}" readonly style="background:#eee;">
      {% else %}
      <input type="text" name="regiao" value="{{ regiao or '' }}" placeholder="(todas)">
    <!-- Ou, se preferires um select:
    <select name="regiao">
      <option value="">Todas</option>
      {% for r in regioes %}
        <option value="{{ r }}" {% if regiao == r %}selected{% endif %}>{{ r }}</option>
      {% endfor %}
    </select>
    -->
      {% endif %}
    </label>
    <label>Empresa:
      <select name="empresa">
        <option value="">Todas</option>
        {% for e in empresas %}
          <option value="{{ e }}" {% if empresa == e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
    </label>
    <button class="btn btn-primary" type="submit">Filtrar</button>
    {% if mes or protocolo_id or regiao or empresa %}
      <a class="btn" href="{{ url_for('contabilidade') }}">Limpar filtro</a>
    {% endif %}
    <a class="btn" href="{{ url_for('exportar_contabilidade_excel', mes=mes, protocolo_id=protocolo_id, regiao=regiao, empresa=empresa) }}">Exportar Excel</a>
  </form>
  <table>
    <thead>
      <tr>
        <th>ID Região</th>
        <th>Data</th>
        <th>Matrícula</th>
        <th>Nº Frota</th>
        <th>Região</th>
        <th>Protocolo</th>
        <th>Custo (€)</th>
        <th>Funcionário</th>
        <th>Local</th>
        <th>Empresa</th>
      </tr>
    </thead>
    <tbody>
      {% for r in registos %}
      <tr>
        <td style="white-space:nowrap;">{{ r.id_regiao }}</td>
        <td>{{ r.data }}</td>
        <td>{{ r.matricula }}</td>
        <td>{{ r.num_frota or "" }}</td>
        <td>{{ r.regiao or "" }}</td>
        <td>{{ r.protocolo }}</td>
        <td>{{ "%.2f"|format(r.custo_limpeza or 0) }}</td>
        <td>{{ r.funcionario }}</td>
        <td>{{ r.local or "" }}</td>
        <td>{{ r.empresa or "—" }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="6" style="text-align:right;font-weight:bold;">Total:</td>
        <td style="font-weight:bold;">{{ "%.2f"|format(total) }} €</td>
        <td colspan="3"></td>
      </tr>
    </tfoot>
  </table>
{% endblock %}